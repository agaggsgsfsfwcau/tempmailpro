<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Temp Mail Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --gray: #6c757d;
      --success: #4cc9f0;
      --warning: #f8961e;
      --error: #f94144;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--light);
      margin: 0;
      padding: 0;
      color: #333;
      transition: all 0.3s ease;
    }

    .dark-mode {
      background: var(--dark);
      color: var(--light);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1, h2, h3 {
      font-family: 'Oswald', sans-serif;
      letter-spacing: 0.5px;
    }

    h1 {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 5px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .dark-mode h1 {
      color: var(--success);
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }

    .dark-mode .card {
      background: #16213e;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .email-display {
      font-size: 1.2rem;
      margin: 15px 0;
      padding: 12px;
      background: rgba(67, 97, 238, 0.1);
      border-radius: 8px;
      word-break: break-word;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dark-mode .email-display {
      background: rgba(76, 201, 240, 0.1);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }

    button {
      font-family: 'Roboto', sans-serif;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .dark-mode button {
      background: var(--success);
      color: var(--dark);
    }

    .dark-mode button:hover {
      background: #3ab7d8;
    }

    button.outlined {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .dark-mode button.outlined {
      border-color: var(--success);
      color: var(--success);
    }

    .email-box {
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.2s ease;
    }

    .email-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .dark-mode .email-box:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .email-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 500;
      align-items: center;
    }

    .email-subject {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      color: var(--primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dark-mode .email-subject {
      color: var(--success);
    }

    .email-content {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 0.9rem;
      line-height: 1.5;
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .email-full-content {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 0.9rem;
      line-height: 1.5;
      overflow: auto;
      max-height: 400px;
    }

    .dark-mode .email-content,
    .dark-mode .email-full-content {
      background: rgba(255,255,255,0.05);
    }

    .email-date {
      color: var(--gray);
      font-size: 0.85rem;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .empty-inbox {
      text-align: center;
      padding: 30px;
      color: var(--gray);
      font-style: italic;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--primary);
      color: white;
      margin-left: 8px;
      gap: 4px;
    }

    .dark-mode .badge {
      background: var(--success);
      color: var(--dark);
    }

    .badge.warning {
      background: var(--warning);
      color: white;
    }

    .badge.error {
      background: var(--error);
      color: white;
    }

    .material-icons {
      font-size: 1.2em;
      vertical-align: middle;
    }

    .snackbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .snackbar.show {
      opacity: 1;
    }

    .snackbar.success {
      background: var(--success);
      color: var(--dark);
    }

    .snackbar.error {
      background: var(--error);
    }

    .progress-bar {
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .dark-mode .progress {
      background: var(--success);
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .dark-mode .avatar {
      background: var(--success);
      color: var(--dark);
    }

    .accounts-list {
      margin-top: 20px;
      border-top: 1px solid rgba(0,0,0,0.1);
      padding-top: 15px;
    }

    .account-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(0,0,0,0.03);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .account-item:hover {
      background: rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }

    .dark-mode .account-item {
      background: rgba(255,255,255,0.05);
    }

    .dark-mode .account-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .account-item.active {
      background: rgba(67, 97, 238, 0.1);
      border-left: 3px solid var(--primary);
    }

    .dark-mode .account-item.active {
      background: rgba(76, 201, 240, 0.1);
      border-left: 3px solid var(--success);
    }

    .account-actions {
      display: flex;
      gap: 5px;
    }

    .account-actions button {
      padding: 5px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .dark-mode .modal-content {
      background: #16213e;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      color: var(--primary);
    }

    .dark-mode .modal-header h2 {
      color: var(--success);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Roboto', sans-serif;
    }

    .dark-mode .form-group input, 
    .dark-mode .form-group select {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
      color: white;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      .controls {
        flex-direction: column;
      }
      button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <span class="material-icons">email</span>
        Temp Mail Pro
      </h1>
      <p>Disposable Email Service</p>
    </div>

    <div class="card">
      <h2>Your Temporary Email</h2>
      <div class="email-display" id="email">
        <span>Generating your random email address...</span>
        <button class="outlined" onclick="copyEmail(event)" style="padding: 6px 12px;">
          <span class="material-icons">content_copy</span>
          Copy
        </button>
      </div>

      <div class="controls">
        <button onclick="refreshInbox()">
          <span class="material-icons">refresh</span>
          Refresh Inbox
        </button>
        <button onclick="showCreateModal()">
          <span class="material-icons">add</span>
          Create Email
        </button>
        <button onclick="toggleDarkMode()">
          <span class="material-icons">brightness_4</span>
          Toggle Theme
        </button>
      </div>

      <div class="progress-bar">
        <div class="progress" id="refreshProgress"></div>
      </div>
      <p>Inbox auto-refreshes every 15 seconds <span class="badge"><span class="material-icons">flash_on</span> Live</span></p>

      <div class="accounts-list" id="accountsList">
        <h3>Your Accounts</h3>
        <div id="accountsContainer"></div>
      </div>
    </div>

    <div class="card">
      <h2>Inbox Messages</h2>
      <div id="inbox">
        <div class="empty-inbox">Loading your messages...</div>
      </div>
    </div>
  </div>

  <!-- Create Email Modal -->
  <div class="modal" id="createModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Email</h2>
        <button class="close-modal" onclick="closeModal('createModal')">&times;</button>
      </div>
      <div class="form-group">
        <label for="emailType">Email Type</label>
        <select id="emailType" onchange="toggleCustomEmailField()">
          <option value="random">Random Email</option>
          <option value="custom">Custom Username</option>
        </select>
      </div>
      <div class="form-group" id="customEmailGroup" style="display: none;">
        <label for="customUsername">Custom Username</label>
        <input type="text" id="customUsername" placeholder="Enter your desired username">
      </div>
      <div class="modal-footer">
        <button class="outlined" onclick="closeModal('createModal')">Cancel</button>
        <button onclick="createNewAccount()">Create Email</button>
      </div>
    </div>
  </div>

  <!-- Change Email Modal -->
  <div class="modal" id="changeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Change Email Address</h2>
        <button class="close-modal" onclick="closeModal('changeModal')">&times;</button>
      </div>
      <div class="form-group">
        <label for="newUsername">New Username</label>
        <input type="text" id="newUsername" placeholder="Enter new username">
      </div>
      <div class="modal-footer">
        <button class="outlined" onclick="closeModal('changeModal')">Cancel</button>
        <button onclick="changeEmailAddress()">Update Email</button>
      </div>
    </div>
  </div>

  <div class="snackbar" id="snackbar">
    <span class="material-icons" id="snackbarIcon">check_circle</span>
    <span id="snackbarMessage">Success!</span>
  </div>

  <audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

  <script>
    let accounts = [];
    let currentAccount = null;
    let autoRefreshInterval = null;
    let progressInterval = null;

    // Load accounts from localStorage when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadAccounts();
      if (accounts.length > 0) {
        // If we have accounts, use the first one by default
        switchAccount(accounts[0].id);
      } else {
        // Otherwise, automatically create a random account
        showCreateModal();
      }
    });

    // Account management functions
    function loadAccounts() {
      const savedAccounts = localStorage.getItem('tempMailAccounts');
      if (savedAccounts) {
        accounts = JSON.parse(savedAccounts);
        renderAccountsList();
      }
    }

    function saveAccounts() {
      localStorage.setItem('tempMailAccounts', JSON.stringify(accounts));
      renderAccountsList();
    }

    function renderAccountsList() {
      const container = document.getElementById('accountsContainer');
      if (accounts.length === 0) {
        container.innerHTML = '<p>No accounts yet. Create your first email above.</p>';
        return;
      }

      container.innerHTML = accounts.map(account => `
        <div class="account-item ${currentAccount?.id === account.id ? 'active' : ''}" data-id="${account.id}" onclick="switchAccount('${account.id}', event)">
          <div>
            <strong>${account.email}</strong>
            <div style="font-size: 0.8rem; color: var(--gray);">Created: ${formatDate(account.createdAt)}</div>
          </div>
          <div class="account-actions">
            <button class="outlined" onclick="showChangeModal('${account.id}', event)" style="padding: 5px 10px;">
              <span class="material-icons">edit</span>
            </button>
            <button class="outlined" onclick="copyAccountEmail('${account.id}', event)" style="padding: 5px 10px;">
              <span class="material-icons">content_copy</span>
            </button>
            <button class="outlined" onclick="deleteAccount('${account.id}', event)" style="padding: 5px 10px;">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Modal functions
    function showCreateModal() {
      document.getElementById('createModal').style.display = 'flex';
    }

    function showChangeModal(accountId, event) {
      if (event) event.stopPropagation();
      const account = accounts.find(a => a.id === accountId);
      if (!account) return;
      
      // Extract the username part (before @)
      const username = account.email.split('@')[0];
      document.getElementById('newUsername').value = username;
      document.getElementById('newUsername').dataset.accountId = accountId;
      document.getElementById('changeModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function toggleCustomEmailField() {
      const emailType = document.getElementById('emailType').value;
      const customEmailGroup = document.getElementById('customEmailGroup');
      customEmailGroup.style.display = emailType === 'custom' ? 'block' : 'none';
    }

    // Account creation and modification
    async function createNewAccount() {
      const emailType = document.getElementById('emailType').value;
      let username = '';
      
      if (emailType === 'custom') {
        username = document.getElementById('customUsername').value.trim();
        if (!username) {
          showSnackbar('Please enter a username', 'error');
          return;
        }
        if (!/^[a-zA-Z0-9_.-]+$/.test(username)) {
          showSnackbar('Username can only contain letters, numbers, dots, underscores and hyphens', 'error');
          return;
        }
      } else {
        // Generate random username
        username = Math.random().toString(36).substring(2, 8);
      }
      
      try {
        showLoading('Creating your email address...');
        
        // Get available domains
        const domainsRes = await fetch('https://api.mail.tm/domains');
        const domainsData = await domainsRes.json();
        const domain = domainsData['hydra:member'][0].domain;

        // Create email and password
        const email = `${username}@${domain}`;
        const password = generateStrongPassword();

        // Create account
        await fetch('https://api.mail.tm/accounts', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ address: email, password })
        });

        // Get token
        const loginRes = await fetch('https://api.mail.tm/token', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ address: email, password })
        });

        const loginData = await loginRes.json();
        const token = loginData.token;

        // Create account object
        const newAccount = {
          id: generateId(),
          email,
          password,
          token,
          createdAt: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        };

        // Add to accounts and make it current
        accounts.push(newAccount);
        saveAccounts();
        switchAccount(newAccount.id);
        closeModal('createModal');

        showSnackbar('Email created successfully!', 'success');
      } catch (error) {
        showSnackbar(`Error creating email: ${error.message}`, 'error');
      }
    }

    async function changeEmailAddress() {
      const newUsername = document.getElementById('newUsername').value.trim();
      const accountId = document.getElementById('newUsername').dataset.accountId;
      
      if (!newUsername) {
        showSnackbar('Please enter a username', 'error');
        return;
      }
      
      if (!/^[a-zA-Z0-9_.-]+$/.test(newUsername)) {
        showSnackbar('Username can only contain letters, numbers, dots, underscores and hyphens', 'error');
        return;
      }
      
      const account = accounts.find(a => a.id === accountId);
      if (!account) return;
      
      try {
        showLoading('Updating your email address...');
        
        // Get available domains
        const domainsRes = await fetch('https://api.mail.tm/domains');
        const domainsData = await domainsRes.json();
        const domain = domainsData['hydra:member'][0].domain;

        // Create new email
        const newEmail = `${newUsername}@${domain}`;
        
        // First create the new account
        const newPassword = generateStrongPassword();
        
        await fetch('https://api.mail.tm/accounts', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ address: newEmail, password: newPassword })
        });

        // Get token for new account
        const loginRes = await fetch('https://api.mail.tm/token', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ address: newEmail, password: newPassword })
        });

        const loginData = await loginRes.json();
        const newToken = loginData.token;

        // Update the existing account object
        account.email = newEmail;
        account.password = newPassword;
        account.token = newToken;
        account.lastUsed = new Date().toISOString();
        
        // Try to delete the old account from server (may fail if already deleted)
        try {
          await fetch(`https://api.mail.tm/accounts/${account.id}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${account.token}` }
          });
        } catch (e) {
          console.log('Old account deletion from server failed (may already be gone)');
        }
        
        saveAccounts();
        switchAccount(account.id);
        closeModal('changeModal');

        showSnackbar('Email updated successfully!', 'success');
      } catch (error) {
        showSnackbar(`Error updating email: ${error.message}`, 'error');
      }
    }

    async function switchAccount(accountId, event) {
      if (event) {
        event.stopPropagation();
        // Prevent switching if clicking on action buttons
        if (event.target.closest('.account-actions')) {
          return;
        }
      }
      
      const account = accounts.find(a => a.id === accountId);
      if (!account) return;

      // Stop any existing auto-refresh
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      if (progressInterval) clearInterval(progressInterval);

      // Set as current account
      currentAccount = account;
      account.lastUsed = new Date().toISOString();
      saveAccounts();

      // Update UI
      document.getElementById('email').innerHTML = `
        <span>${account.email}</span>
        <button class="outlined" onclick="copyEmail(event)" style="padding: 6px 12px;">
          <span class="material-icons">content_copy</span>
          Copy
        </button>
      `;

      // Refresh inbox
      refreshInbox();
      startAutoRefresh();
    }

    function copyAccountEmail(accountId, event) {
      event.stopPropagation();
      const account = accounts.find(a => a.id === accountId);
      if (account) {
        navigator.clipboard.writeText(account.email).then(() => {
          showSnackbar('Email copied to clipboard!', 'success');
        });
      }
    }

    async function deleteAccount(accountId, event) {
      event.stopPropagation();
      
      if (!confirm('Are you sure you want to delete this email account? All messages will be lost.')) {
        return;
      }

      const account = accounts.find(a => a.id === accountId);
      if (!account) return;

      try {
        // Try to delete from server (may fail if already deleted)
        try {
          await fetch(`https://api.mail.tm/accounts/${account.id}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${account.token}` }
          });
        } catch (e) {
          console.log('Account deletion from server failed (may already be gone)');
        }

        // Remove from our list
        accounts = accounts.filter(a => a.id !== accountId);
        saveAccounts();

        // If we deleted the current account, switch to another or create new
        if (currentAccount?.id === accountId) {
          if (accounts.length > 0) {
            switchAccount(accounts[0].id);
          } else {
            currentAccount = null;
            document.getElementById('email').innerHTML = '<span>No active email account</span>';
            document.getElementById('inbox').innerHTML = '<div class="empty-inbox">No active email account. Create a new one above.</div>';
          }
        }

        showSnackbar('Account deleted', 'success');
      } catch (error) {
        showSnackbar(`Error deleting account: ${error.message}`, 'error');
      }
    }

    // Inbox management functions
    function startAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      if (progressInterval) clearInterval(progressInterval);
      
      if (!currentAccount) return;
      
      autoRefreshInterval = setInterval(refreshInbox, 15000);
      
      // Animate progress bar
      const progressBar = document.getElementById('refreshProgress');
      progressBar.style.width = '100%';
      progressBar.style.transition = 'width 15s linear';
      
      setTimeout(() => {
        progressBar.style.width = '0%';
        progressBar.style.transition = 'none';
        setTimeout(() => {
          progressBar.style.transition = 'width 15s linear';
        }, 10);
      }, 15000);
    }

    async function refreshInbox() {
      if (!currentAccount?.token) return;
      try {
        const inboxRes = await fetch('https://api.mail.tm/messages', {
          headers: { Authorization: `Bearer ${currentAccount.token}` }
        });

        const inboxData = await inboxRes.json();
        const messages = inboxData['hydra:member'];
        const inboxDiv = document.getElementById('inbox');

        if (messages.length === 0) {
          inboxDiv.innerHTML = '<div class="empty-inbox">Your inbox is empty. Share your temporary email to receive messages.</div>';
          return;
        }

        messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        inboxDiv.innerHTML = messages.map(msg => `
          <div class="email-box">
            <div class="email-header">
              <div style="display: flex; align-items: center; gap: 10px;">
                <div class="avatar">${msg.from?.name?.charAt(0) || '?'}</div>
                <span>${msg.from?.address || 'Unknown'}</span>
              </div>
              <span class="email-date">
                <span class="material-icons" style="font-size: 1rem;">schedule</span>
                ${formatDate(msg.createdAt)}
              </span>
            </div>
            <div class="email-subject">
              <span class="material-icons">email</span>
              ${msg.subject || '(No Subject)'}
            </div>
            <div class="email-content">${msg.intro || 'Preview not available'}</div>
            <button onclick="showFullMessage('${msg.id}', this)">
              <span class="material-icons">fullscreen</span>
              View Full Message
            </button>
            <div id="msg-${msg.id}" style="display:none;"></div>
          </div>`).join('');

      } catch (err) {
        console.error('Inbox Error:', err);
        showSnackbar('Error refreshing inbox', 'error');
      }
    }

    async function showFullMessage(id, btn) {
      if (!currentAccount?.token) return;
      
      try {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="material-icons">hourglass_top</span> Loading...';
        btn.disabled = true;

        const res = await fetch(`https://api.mail.tm/messages/${id}`, {
          headers: { Authorization: `Bearer ${currentAccount.token}` }
        });

        if (!res.ok) {
          throw new Error('Failed to fetch message');
        }

        const data = await res.json();
        const msgDiv = document.getElementById(`msg-${id}`);
        
        // Create a safe preview of the content
        let content = data.text || data.html || 'No content available';
        if (data.html) {
          // For HTML content, we'll create a sandboxed iframe
          const iframe = document.createElement('iframe');
          iframe.sandbox = 'allow-same-origin';
          iframe.style.width = '100%';
          iframe.style.height = '400px';
          iframe.style.border = 'none';
          iframe.style.backgroundColor = 'transparent';
          iframe.srcdoc = `
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body {
                  font-family: Arial, sans-serif;
                  padding: 15px;
                  margin: 0;
                  background-color: transparent;
                }
              </style>
            </head>
            <body>
              ${data.html}
            </body>
            </html>
          `;
          
          // Clear previous content and append iframe
          msgDiv.innerHTML = '';
          msgDiv.appendChild(iframe);
        } else {
          // For plain text, just display with proper formatting
          msgDiv.innerHTML = `
            <div class="email-full-content">
              ${content.replace(/\n/g, '<br>')}
            </div>
          `;
        }
        
        msgDiv.style.display = 'block';
        btn.innerHTML = '<span class="material-icons">fullscreen_exit</span> Hide Message';
        btn.onclick = function() {
          toggleMessageDisplay(id, btn, originalText);
        };
        
      } catch (err) {
        console.error('Error loading message:', err);
        showSnackbar('Error loading message', 'error');
        btn.innerHTML = originalText;
      } finally {
        btn.disabled = false;
      }
    }

    function toggleMessageDisplay(id, btn, originalText) {
      const msgDiv = document.getElementById(`msg-${id}`);
      if (msgDiv.style.display === 'none') {
        msgDiv.style.display = 'block';
        btn.innerHTML = '<span class="material-icons">fullscreen_exit</span> Hide Message';
      } else {
        msgDiv.style.display = 'none';
        btn.innerHTML = originalText;
        btn.onclick = function() {
          showFullMessage(id, btn);
        };
      }
    }

    // Utility functions
    function copyEmail(e) {
      if (!currentAccount?.email) return;
      navigator.clipboard.writeText(currentAccount.email).then(() => {
        showSnackbar('Email copied to clipboard!', 'success');
      });
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const icon = document.querySelector('button[onclick="toggleDarkMode()"] .material-icons');
      icon.textContent = document.body.classList.contains('dark-mode') ? 'brightness_7' : 'brightness_4';
    }

    function formatDate(date) {
      return new Date(date).toLocaleString();
    }

    function generateStrongPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
      return Array.from({ length: 16 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function generateId() {
      return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    function showLoading(msg) {
      document.getElementById('inbox').innerHTML = `<div class="empty-inbox">${msg}</div>`;
    }

    function showSnackbar(msg, type = 'success') {
      const snackbar = document.getElementById('snackbar');
      const icon = document.getElementById('snackbarIcon');
      const message = document.getElementById('snackbarMessage');
      
      snackbar.className = 'snackbar';
      snackbar.classList.add(type);
      
      icon.textContent = type === 'success' ? 'check_circle' : 'error';
      message.textContent = msg;
      
      snackbar.classList.add('show');
      setTimeout(() => {
        snackbar.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>